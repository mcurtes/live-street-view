<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Street View Containers</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #street-view {
        height: 100%;
      }
    </style>
  </head>
  <body onload="getLocation()">
    <div id="street-view"></div>
    <script>
      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(initialize);
        } else { 
          console.warn = "Geolocation is not supported by this browser.";
        }
      }
    
      var browserHeading = null;
      var browserPitch = null;

      window.addEventListener('deviceorientation', deviceOrientationListener, false);

      function deviceOrientationListener(event) {
        console.log("browserHeading: " + browserHeading + " browserPitch: " + browserPitch);
        browserHeading = event.alpha;
        browserPitch = event.beta;
      }

      // Subtract browser's reported heading from 360 to get value where 0 = due North. W3C uses different values than Street View. W3C: https://developer.mozilla.org/en-US/docs/Web/API/DeviceOrientationEvent#Properties  Street View: https://developers.google.com/web/fundamentals/native-hardware/device-orientation/      
      var calculatedHeading = ((360 - browserHeading) % 360);

      var panorama;

      function initialize(position) {
        currentLat = position.coords.latitude;
        currentLon = position.coords.longitude;
        console.log("currentLat: " + currentLat + " currentLon: " + currentLon);
        if (browserHeading) {
          console.log("calculatedHeading: " + calculatedHeading);
          panorama = new google.maps.StreetViewPanorama(
          document.getElementById('street-view'),
          {
            position: {lat: currentLat, lng: currentLon},
            pov: {heading: calculatedHeading, pitch: 0},
            zoom: 1,
            zoomControl: false,
            fullscreenControl: false,
            addressControl: false,
            panControl: false,
            linksControl: false,
            motionTrackingControl: false
          });
        }
        else {
          alert("Could not fetch heading; defaulting calculatedHeading to 0"); //TODO: Figure out why this seems to always happen. Seems like it might be a timing issue, whereby we are calling this before we've had a chance to get heading
          console.log("Could not fetch heading; defaulting calculatedHeading to 0");
          panorama = new google.maps.StreetViewPanorama(
          document.getElementById('street-view'),
          {
            position: {lat: currentLat, lng: currentLon},
            pov: {heading: 0, pitch: 0},
            zoom: 1,
            zoomControl: false,
            fullscreenControl: false,
            addressControl: false,
            panControl: false,
            linksControl: false,
            motionTrackingControl: false
          });
        }
        watchLocation();
      }

      function watchLocation() {
        navigator.geolocation.watchPosition(updateLocation);
      }

      function updateLocation(updatedPosition) {
        updatedLat = updatedPosition.coords.latitude;
        updatedLon = updatedPosition.coords.longitude;
        console.log("updatedLat: " + updatedLat + " updatedLon: " + updatedLon);
        panorama.setPosition({lat: updatedLat, lng: updatedLon});
      }

    </script>
    <script async defer
         src="https://maps.googleapis.com/maps/api/js?key=AIzaSyANiDfdQzJPhx6Vrsy8nkPpwek9A4azbUE&callback=getLocation">
    </script>
  </body>
</html>